version: "3.9"

services:
  mcp-server:
    build:
      context: ../mcp-server
      dockerfile: ../infra/Dockerfile.mcp-server
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EVALPRD_MODEL=${EVALPRD_MODEL:-gpt-4o}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - REQUEST_TIMEOUT_MS=${REQUEST_TIMEOUT_MS:-60000}
      - OPENAI_MAX_RETRIES=${OPENAI_MAX_RETRIES:-1}
    restart: unless-stopped

  api-gateway:
    build:
      context: ../api-gateway
      dockerfile: ../infra/Dockerfile.api-gateway
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - MCP_SERVER_COMMAND=node
      - MCP_SERVER_ARGS=/app/mcp-server/dist/index.js
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
      - PORT=8080
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-60}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
    depends_on:
      - mcp-server
    restart: unless-stopped
    volumes:
      - ../mcp-server/dist:/app/mcp-server/dist:ro

  frontend:
    build:
      context: ../frontend
      dockerfile: ../infra/Dockerfile.frontend
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:8080
    depends_on:
      - api-gateway
    restart: unless-stopped
