<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Upload Flow</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .loading {
      color: #0066cc;
      font-weight: bold;
    }
    .success {
      color: #00aa00;
      font-weight: bold;
    }
    .error {
      color: #cc0000;
      font-weight: bold;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <h1>Test EvalPRD Upload Flow</h1>

  <div class="section">
    <h2>Step 1: Binary Score</h2>
    <button onclick="testBinaryScore()">Test Binary Score API</button>
    <div id="binary-status"></div>
    <pre id="binary-result"></pre>
  </div>

  <div class="section">
    <h2>Step 2: Fix Plan</h2>
    <button onclick="testFixPlan()">Test Fix Plan API</button>
    <div id="fixplan-status"></div>
    <pre id="fixplan-result"></pre>
  </div>

  <div class="section">
    <h2>Step 3: Agent Tasks</h2>
    <button onclick="testAgentTasks()">Test Agent Tasks API</button>
    <div id="tasks-status"></div>
    <pre id="tasks-result"></pre>
  </div>

  <div class="section">
    <h2>All Together</h2>
    <button onclick="testFullFlow()">Test Complete Flow</button>
    <div id="full-status"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080';
    const TEST_PRD = `# User Dashboard PRD

## Problem Statement
Users need a centralized dashboard to view their account metrics and activity.

## Solution
Build a responsive dashboard with real-time data visualization.

## Requirements
- Display user metrics (orders, revenue, activity)
- Real-time updates via WebSocket
- Mobile responsive design
- Export data to CSV

## Technical Requirements
- React frontend
- Node.js backend
- PostgreSQL database
- Redis for caching

## Success Criteria
- Load time < 2 seconds
- 99.9% uptime
- Support 10,000 concurrent users`;

    async function streamAPI(endpoint, onProgress) {
      const response = await fetch(`${API_BASE}/api/evalprd/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prd_text: TEST_PRD })
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      if (!response.body) throw new Error('No response body');

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\\n');
        buffer = lines.pop() || '';

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'delta') {
              onProgress?.(data.delta, data.accumulated);
            } else if (data.type === 'done') {
              return data.result;
            } else if (data.type === 'error') {
              throw new Error(data.error);
            }
          }
        }
      }

      throw new Error('Stream ended without completion');
    }

    async function testBinaryScore() {
      const status = document.getElementById('binary-status');
      const result = document.getElementById('binary-result');
      
      status.innerHTML = '<span class="loading">Loading...</span>';
      result.textContent = '';

      try {
        const data = await streamAPI('binary_score', (delta, accumulated) => {
          status.innerHTML = `<span class="loading">Streaming... (${accumulated} chars)</span>`;
        });
        
        status.innerHTML = '<span class="success">✓ Success</span>';
        result.textContent = JSON.stringify(data, null, 2);
        console.log('Binary Score:', data);
      } catch (error) {
        status.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
        console.error('Binary Score Error:', error);
      }
    }

    async function testFixPlan() {
      const status = document.getElementById('fixplan-status');
      const result = document.getElementById('fixplan-result');
      
      status.innerHTML = '<span class="loading">Loading...</span>';
      result.textContent = '';

      try {
        const data = await streamAPI('fix_plan', (delta, accumulated) => {
          status.innerHTML = `<span class="loading">Streaming... (${accumulated} chars)</span>`;
        });
        
        status.innerHTML = '<span class="success">✓ Success</span>';
        result.textContent = JSON.stringify(data, null, 2);
        console.log('Fix Plan:', data);
      } catch (error) {
        status.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
        console.error('Fix Plan Error:', error);
      }
    }

    async function testAgentTasks() {
      const status = document.getElementById('tasks-status');
      const result = document.getElementById('tasks-result');
      
      status.innerHTML = '<span class="loading">Loading...</span>';
      result.textContent = '';

      try {
        const data = await streamAPI('agent_tasks', (delta, accumulated) => {
          status.innerHTML = `<span class="loading">Streaming... (${accumulated} chars)</span>`;
        });
        
        status.innerHTML = '<span class="success">✓ Success</span>';
        result.textContent = JSON.stringify(data, null, 2);
        console.log('Agent Tasks:', data);
        console.log('Number of tasks:', data.tasks?.length);
      } catch (error) {
        status.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
        console.error('Agent Tasks Error:', error);
      }
    }

    async function testFullFlow() {
      const status = document.getElementById('full-status');
      
      status.innerHTML = '<span class="loading">Testing full flow...</span><br>';
      
      try {
        // Step 1
        status.innerHTML += '<span class="loading">1. Binary Score...</span>';
        const binaryScore = await streamAPI('binary_score');
        status.innerHTML += ' <span class="success">✓</span><br>';
        
        // Step 2
        status.innerHTML += '<span class="loading">2. Fix Plan...</span>';
        const fixPlan = await streamAPI('fix_plan');
        status.innerHTML += ' <span class="success">✓</span><br>';
        
        // Step 3
        status.innerHTML += '<span class="loading">3. Agent Tasks...</span>';
        const agentTasks = await streamAPI('agent_tasks');
        status.innerHTML += ' <span class="success">✓</span><br>';
        
        status.innerHTML += `<br><span class="success">✓ All tests passed!</span><br>`;
        status.innerHTML += `<br>Results:<br>`;
        status.innerHTML += `- Binary Score: ${binaryScore.criteria?.length || 0} criteria<br>`;
        status.innerHTML += `- Fix Plan: ${fixPlan.fix_plan?.length || 0} items<br>`;
        status.innerHTML += `- Agent Tasks: ${agentTasks.tasks?.length || 0} tasks<br>`;
        
        console.log('Full Flow Results:', { binaryScore, fixPlan, agentTasks });
      } catch (error) {
        status.innerHTML += `<br><span class="error">✗ Error: ${error.message}</span>`;
        console.error('Full Flow Error:', error);
      }
    }
  </script>
</body>
</html>

